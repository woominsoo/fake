<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>미니 게임 천국</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }
        .game-wrapper, .lobby-wrapper {
            background-color: #1e293b;
            border: 1px solid #334155;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            filter: brightness(1.1);
        }
        .btn:active {
            transform: translateY(1px);
            filter: brightness(0.9);
        }
        .btn-bet {
            background-color: #22c55e;
            color: #0f172a;
        }
        .btn-bet:hover {
            background-color: #4ade80;
        }
        .btn-bet:disabled {
            background-color: #166534;
            opacity: 0.5;
            cursor: not-allowed;
        }
        .bet-control {
            background-color: #334155;
            color: #e2e8f0;
        }
        .bet-input {
            background-color: #0f172a;
            border: 1px solid #334155;
            text-align: center;
            width: 100px;
        }
        .plinko-canvas, .crash-canvas {
            display: block;
            margin: 0 auto;
            background-color: #0f172a;
        }
        .multiplier-box {
            transition: all 0.2s ease;
            font-size: 10px;
        }
        .multiplier-box.hit {
            background-color: #ffffff !important;
            color: #000000 !important;
            z-index: 10;
        }
        @keyframes jump {
            0% { transform: translateY(0) scale(1.0); }
            50% { transform: translateY(-8px) scale(1.1); }
            100% { transform: translateY(0) scale(1.0); }
        }
        .hit-animation {
            animation: jump 0.4s ease-out;
        }
        .lobby-card {
            background-color: #334155;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
        }
        .lobby-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }
        .bet-slider {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 8px; background: #334155;
            outline: none; opacity: 0.7; transition: opacity .2s;
            border-radius: 4px;
        }
        .bet-slider:hover { opacity: 1; }
        .bet-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 20px; height: 20px; background: #22c55e;
            cursor: pointer; border-radius: 50%;
        }
        .bet-slider::-moz-range-thumb {
            width: 20px; height: 20px; background: #22c55e;
            cursor: pointer; border-radius: 50%;
        }
        .crash-multiplier {
            font-weight: 700;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: color 0.3s ease;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="lobbyView" class="w-full max-w-lg mx-auto">
        <div class="lobby-wrapper rounded-lg p-6">
            <h1 class="text-3xl font-bold text-center text-white mb-6">게임 선택</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div id="plinkoLobbyBtn" class="lobby-card rounded-lg p-6 text-center">
                    <h2 class="text-2xl font-bold text-white">플링코</h2>
                </div>
                <div id="crashLobbyBtn" class="lobby-card rounded-lg p-6 text-center">
                    <h2 class="text-2xl font-bold text-white">크래시</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Plinko Game View -->
    <div id="plinkoGameView" class="w-full max-w-lg mx-auto hidden">
        <header class="flex justify-between items-center mb-4 px-2">
            <button class="menuBtn btn bg-slate-700 text-white font-bold py-2 px-4 rounded">메뉴</button>
            <button class="chargeBtn btn bg-blue-600 text-white font-bold py-2 px-4 rounded">잔액 충전</button>
        </header>
        <div class="game-wrapper rounded-lg">
            <div class="p-4">
                <h1 class="text-2xl font-bold text-center mb-4 text-white">플링코</h1>
                <div class="mb-4">
                    <label class="text-sm text-slate-400">잔액</label>
                    <div class="balance text-2xl font-bold text-white"></div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm text-slate-400">베팅 금액</label>
                        <div class="flex items-center mt-1">
                            <button class="betHalf btn-bet-control font-bold py-2 px-4 rounded-l">-</button>
                            <input type="text" class="betAmount bet-input py-2 flex-grow">
                            <button class="betDouble btn-bet-control font-bold py-2 px-4 rounded-r">+</button>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm text-slate-400">&nbsp;</label>
                        <button class="plinkoBetBtn btn btn-bet w-full font-bold py-2 px-4 rounded mt-1 text-lg">Bet</button>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center gap-4">
                        <input type="range" min="0" max="100" class="bet-slider w-full">
                        <span class="bet-percentage bg-slate-700 text-white font-bold py-1 px-3 rounded text-xs w-16 text-center">0%</span>
                    </div>
                </div>
            </div>
            <div class="p-2">
                <canvas class="plinko-canvas"></canvas>
                <div class="plinko-multipliers-container flex justify-center gap-1 mt-2 relative"></div>
            </div>
        </div>
    </div>

    <!-- Crash Game View -->
    <div id="crashGameView" class="w-full max-w-5xl mx-auto hidden">
         <header class="flex justify-between items-center mb-4 px-2">
            <button class="menuBtn btn bg-slate-700 text-white font-bold py-2 px-4 rounded">메뉴</button>
            <button class="chargeBtn btn bg-blue-600 text-white font-bold py-2 px-4 rounded">잔액 충전</button>
        </header>
        <div class="game-wrapper rounded-lg flex flex-col md:grid md:grid-cols-3">
            <!-- Graph Display (Mobile: top, Desktop: right) -->
            <div class="p-2 md:p-4 md:col-span-2 relative h-64 md:h-[500px] order-1 md:order-2">
                <canvas class="crash-canvas rounded-lg"></canvas>
                <div class="crash-multiplier text-green-400 text-6xl md:text-8xl">1.00x</div>
                <div class="crash-status absolute top-4 left-4 text-white bg-black/50 px-3 py-1 rounded-md text-lg"></div>
            </div>
            <!-- Control Panel (Mobile: bottom, Desktop: left) -->
            <div class="p-4 md:col-span-1 md:border-r md:border-slate-700 order-2 md:order-1">
                <h1 class="text-2xl font-bold text-center mb-4 text-white hidden md:block">크래시</h1>
                <div class="space-y-4">
                    <div>
                        <label class="text-sm text-slate-400">잔액</label>
                        <div class="balance text-2xl font-bold text-white"></div>
                    </div>
                    <div>
                        <label class="text-sm text-slate-400">베팅 금액</label>
                        <div class="flex items-center mt-1">
                            <button class="betHalf btn-bet-control font-bold py-2 px-4 rounded-l">-</button>
                            <input type="text" class="betAmount bet-input py-2 flex-grow">
                            <button class="betDouble btn-bet-control font-bold py-2 px-4 rounded-r">+</button>
                        </div>
                    </div>
                    <div>
                         <div class="flex items-center gap-4">
                            <input type="range" min="0" max="100" class="bet-slider w-full">
                            <span class="bet-percentage bg-slate-700 text-white font-bold py-1 px-3 rounded text-xs w-16 text-center">0%</span>
                        </div>
                    </div>
                    <div>
                        <button class="crashBetBtn btn btn-bet w-full font-bold py-3 px-4 rounded text-lg">Bet</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div id="messageBox" class="fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg text-sm transition-opacity duration-300 opacity-0 pointer-events-none"></div>

    <div id="chargeModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">잔액 충전</h2>
                <button id="closeModalBtn" class="text-slate-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                <button data-amount="1000" class="charge-amount-btn btn bg-slate-700 p-3 rounded">₩1,000</button>
                <button data-amount="5000" class="charge-amount-btn btn bg-slate-700 p-3 rounded">₩5,000</button>
                <button data-amount="10000" class="charge-amount-btn btn bg-slate-700 p-3 rounded">₩10,000</button>
                <button data-amount="25000" class="charge-amount-btn btn bg-slate-700 p-3 rounded">₩25,000</button>
                <button data-amount="50000" class="charge-amount-btn btn bg-slate-700 p-3 rounded">₩50,000</button>
                <button data-amount="100000" class="charge-amount-btn btn bg-slate-700 p-3 rounded">₩100,000</button>
            </div>
        </div>
    </div>

    <script>
    // --- Global State & Elements ---
    const lobbyView = document.getElementById('lobbyView');
    const messageBox = document.getElementById('messageBox');
    const chargeModal = document.getElementById('chargeModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    
    let balance = 1000;
    let betAmount = 100;
    let activeGame = null;

    // --- Global Functions ---
    function showMessage(msg, type = 'error') {
        messageBox.textContent = msg;
        messageBox.classList.remove('bg-red-500', 'bg-green-500');
        messageBox.classList.add(type === 'error' ? 'bg-red-500' : 'bg-green-500');
        messageBox.classList.remove('opacity-0');
        setTimeout(() => messageBox.classList.add('opacity-0'), 3000);
    }

    function formatCurrency(amount) {
        return `₩${Math.floor(amount).toLocaleString('ko-KR')}`;
    }
    
    function updateAllBalances() {
        document.querySelectorAll('.balance').forEach(el => el.textContent = formatCurrency(balance));
    }
    
    function updateBetControls() {
        document.querySelectorAll('.betAmount').forEach(el => {
            el.value = Math.floor(betAmount).toLocaleString('ko-KR');
        });
        const percentage = balance > 0 ? (betAmount / balance) * 100 : 0;
        document.querySelectorAll('.bet-slider').forEach(slider => {
            slider.value = percentage;
        });
        document.querySelectorAll('.bet-percentage').forEach(el => {
            el.textContent = `${Math.floor(percentage)}%`;
        });
        if (activeGame && activeGame.updateBetButtonState) {
            activeGame.updateBetButtonState();
        }
    }

    function adjustBet(multiplier) {
        let newBet = betAmount * multiplier;
        if (newBet < 1) newBet = 1;
        if (newBet > balance) newBet = balance;
        betAmount = newBet;
        updateBetControls();
    }

    // --- Game Manager ---
    const gameManager = {
        switchTo: (game) => {
            if (activeGame && activeGame.stop && activeGame !== game) {
                activeGame.stop();
            }
            lobbyView.classList.add('hidden');
            plinkoGame.view.classList.add('hidden');
            crashGame.view.classList.add('hidden');
            
            game.view.classList.remove('hidden');
            
            if (!game.initialized) {
                game.init();
            } else if (game.start) {
                game.start();
            }
            
            activeGame = game;
        }
    };

    // --- Plinko Game Object ---
    const plinkoGame = {
        view: document.getElementById('plinkoGameView'),
        initialized: false, canvas: null, ctx: null, betBtn: null,
        pegs: [], balls: [], isAnimating: false, animationFrameId: null,
        PEG_ROWS: 16, PEG_RADIUS: 4, BALL_RADIUS: 7, PEG_COLOR: '#475569',
        MULTIPLIERS: [110, 41, 10, 5, 3, 1.5, 1, 0.5, 0.3, 0.5, 1, 1.5, 3, 5, 10, 41, 110],
        BALL_COLORS: ['#f8fafc', '#f472b6', '#60a5fa', '#facc15', '#4ade80'],

        init() {
            this.initialized = true;
            this.canvas = this.view.querySelector('.plinko-canvas');
            this.ctx = this.canvas.getContext('2d');
            this.betBtn = this.view.querySelector('.plinkoBetBtn');
            this.multipliersContainer = this.view.querySelector('.plinko-multipliers-container');
            this.start();
        },
        
        start() {
            this.resizeCanvas();
            this.setupMultipliers();
            this.setupPegs();
            this.draw();
            updateAllBalances();
            updateBetControls();
        },

        stop() {
             if (this.animationFrameId) {
                cancelAnimationFrame(this.animationFrameId);
                this.isAnimating = false;
            }
        },

        resizeCanvas() {
            const containerWidth = this.canvas.parentElement.clientWidth - 16;
            this.canvas.width = containerWidth;
            this.canvas.height = containerWidth;
        },

        getMultiplierColor(m) {
            if (m >= 100) return '#dc2626'; if (m >= 40) return '#f87171';
            if (m >= 10) return '#f97316'; if (m >= 3) return '#f59e0b';
            if (m >= 1) return '#eab308'; if (m >= 0.5) return '#facc15';
            return '#fde047';
        },

        setupPegs() {
            this.pegs = [];
            const hSpacing = this.canvas.width / (this.PEG_ROWS + 2);
            const vSpacing = (this.canvas.height - 50) / (this.PEG_ROWS + 1);
            for (let row = 0; row < this.PEG_ROWS; row++) {
                const numPegs = row + 2;
                const rowWidth = (numPegs - 1) * hSpacing;
                const startX = (this.canvas.width - rowWidth) / 2;
                for (let col = 0; col < numPegs; col++) {
                    this.pegs.push({ x: startX + col * hSpacing, y: vSpacing * (row + 1.5) });
                }
            }
        },
        
        setupMultipliers() {
            this.multipliersContainer.innerHTML = '';
            const bucketWidth = this.canvas.width / this.MULTIPLIERS.length;
            this.MULTIPLIERS.forEach((m, i) => {
                const el = document.createElement('div');
                el.textContent = `${m}x`;
                el.classList.add('multiplier-box', 'rounded', 'font-bold', 'flex', 'items-center', 'justify-center');
                el.style.width = `${bucketWidth - 2}px`;
                el.style.height = `30px`;
                el.id = `plinko-multiplier-${i}`;
                const color = this.getMultiplierColor(m);
                el.style.backgroundColor = color;
                el.style.color = (m >= 1) ? '#ffffff' : '#1e293b';
                this.multipliersContainer.appendChild(el);
            });
        },
        
        draw() {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            this.ctx.fillStyle = this.PEG_COLOR;
            this.pegs.forEach(peg => {
                this.ctx.beginPath();
                this.ctx.arc(peg.x, peg.y, this.PEG_RADIUS, 0, Math.PI * 2);
                this.ctx.fill();
            });
        },
        
        updateBetButtonState() {
            this.betBtn.disabled = balance < betAmount || betAmount <= 0;
        },
        
        placeBet() {
            if (betAmount <= 0) { showMessage('베팅 금액은 0보다 커야 합니다.'); return; }
            if (betAmount > balance) { showMessage('잔액이 부족합니다.'); return; }
            balance -= betAmount; updateAllBalances();
            const newBall = {
                x: this.canvas.width / 2 + (Math.random() - 0.5) * 10, y: this.BALL_RADIUS,
                vx: (Math.random() - 0.5) * 0.5, vy: 0, bet: betAmount,
                color: this.BALL_COLORS[Math.floor(Math.random() * this.BALL_COLORS.length)], settled: false,
            };
            this.balls.push(newBall);
            if (!this.isAnimating) {
                this.isAnimating = true;
                this.animate();
            }
        },

        animate() {
            this.animationFrameId = requestAnimationFrame(() => this.animate());
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            this.draw();
            for (let i = this.balls.length - 1; i >= 0; i--) {
                let ball = this.balls[i];
                ball.vy += 0.4; ball.x += ball.vx; ball.y += ball.vy;
                if (ball.x - this.BALL_RADIUS < 0 || ball.x + this.BALL_RADIUS > this.canvas.width) {
                    ball.vx *= -0.6;
                    ball.x = Math.max(this.BALL_RADIUS, Math.min(this.canvas.width - this.BALL_RADIUS, ball.x));
                }
                if (!ball.settled) {
                    for (const peg of this.pegs) {
                        const dx = ball.x - peg.x, dy = ball.y - peg.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist < this.BALL_RADIUS + this.PEG_RADIUS) {
                            const angle = Math.atan2(dy, dx);
                            const normalX = dx / dist, normalY = dy / dist;
                            const dot = ball.vx * normalX + ball.vy * normalY;
                            ball.vx = (ball.vx - 2 * dot * normalX) * 0.5;
                            ball.vy = (ball.vy - 2 * dot * normalY) * 0.3;
                            const overlap = this.BALL_RADIUS + this.PEG_RADIUS - dist;
                            ball.x += Math.cos(angle) * overlap;
                            ball.y += Math.sin(angle) * overlap;
                            break;
                        }
                    }
                }
                this.ctx.fillStyle = ball.color;
                this.ctx.beginPath();
                this.ctx.arc(ball.x, ball.y, this.BALL_RADIUS, 0, Math.PI * 2);
                this.ctx.fill();
                if (!ball.settled && ball.y + this.BALL_RADIUS > this.canvas.height - 30) this.endGame(ball);
                if (ball.y - this.BALL_RADIUS > this.canvas.height) this.balls.splice(i, 1);
            }
            if (this.balls.length === 0) {
                this.isAnimating = false;
                cancelAnimationFrame(this.animationFrameId);
            }
        },
        
        endGame(ball) {
            ball.settled = true;
            const bucketWidth = this.canvas.width / this.MULTIPLIERS.length;
            let bucketIndex = Math.floor(ball.x / bucketWidth);
            bucketIndex = Math.max(0, Math.min(this.MULTIPLIERS.length - 1, bucketIndex));
            const multiplier = this.MULTIPLIERS[bucketIndex];
            const winnings = ball.bet * multiplier;
            balance += winnings;
            updateAllBalances();
            const hitEl = this.view.querySelector(`#plinko-multiplier-${bucketIndex}`);
            if (hitEl) {
                hitEl.classList.add('hit', 'hit-animation');
                setTimeout(() => hitEl.classList.remove('hit', 'hit-animation'), 500);
            }
        }
    };

    // --- Crash Game Object ---
    const crashGame = {
        view: document.getElementById('crashGameView'),
        initialized: false, canvas: null, ctx: null, multiplierDisplay: null, statusDisplay: null, betBtn: null,
        state: 'WAITING', multiplier: 1.00, startTime: 0, crashPoint: 0,
        animationFrameId: null, playerBet: null,
        VISUAL_MAX_MULTIPLIER: 30,

        init() {
            this.initialized = true;
            this.canvas = this.view.querySelector('.crash-canvas');
            this.ctx = this.canvas.getContext('2d');
            this.multiplierDisplay = this.view.querySelector('.crash-multiplier');
            this.statusDisplay = this.view.querySelector('.crash-status');
            this.betBtn = this.view.querySelector('.crashBetBtn');
            this.start();
        },
        
        start() {
            this.resizeCanvas();
            if (this.state === 'CRASHED' || (this.state === 'WAITING' && Date.now() > this.startTime)) {
                this.reset();
            }
            this.loop();
            updateAllBalances();
            updateBetControls();
        },

        stop() {
             if (this.animationFrameId) {
                cancelAnimationFrame(this.animationFrameId);
                this.animationFrameId = null;
            }
        },
        
        resizeCanvas() {
            const container = this.canvas.parentElement;
            this.canvas.width = container.clientWidth;
            this.canvas.height = container.clientHeight;
        },

        reset() {
            this.state = 'WAITING'; this.multiplier = 1.00;
            
            const r = Math.random();
            if (r < 0.5) this.crashPoint = 1 + Math.random();          // 50% for 1-2x
            else if (r < 0.75) this.crashPoint = 2 + Math.random();    // 25% for 2-3x
            else if (r < 0.9) this.crashPoint = 3 + Math.random() * 7; // 15% for 3-10x
            else if (r < 0.98) this.crashPoint = 10 + Math.random() * 10;// 8% for 10-20x
            else this.crashPoint = 20 + Math.random() * 10;           // 2% for 20-30x

            this.startTime = Date.now() + 5000; this.playerBet = null;
            this.betBtn.disabled = false; this.betBtn.textContent = 'Bet';
            this.betBtn.classList.remove('bg-red-500'); this.betBtn.classList.add('bg-green-500');
            this.multiplierDisplay.classList.remove('text-red-500');
            this.multiplierDisplay.classList.add('text-green-400');
            this.multiplierDisplay.textContent = '1.00x';
        },

        loop() {
            this.animationFrameId = requestAnimationFrame(() => this.loop());
            this.update();
            this.draw();
        },

        update() {
            const now = Date.now();
            if (this.state === 'WAITING') {
                const countdown = Math.max(0, (this.startTime - now) / 1000).toFixed(1);
                this.statusDisplay.textContent = `다음 라운드 시작까지: ${countdown}s`;
                if (now >= this.startTime) {
                    this.state = 'RUNNING'; this.startTime = now;
                    this.betBtn.disabled = this.playerBet === null;
                    if(this.playerBet) {
                        this.betBtn.textContent = 'Cash Out';
                        this.betBtn.classList.add('bg-red-500');
                        this.betBtn.classList.remove('bg-green-500');
                    }
                }
            } else if (this.state === 'RUNNING') {
                const elapsedTime = (now - this.startTime) / 1000;
                this.multiplier = Math.exp(elapsedTime * 0.17); // 속도 조절
                this.statusDisplay.textContent = ``;
                if (this.playerBet) this.betBtn.textContent = `Cash Out @ ${this.multiplier.toFixed(2)}x`;
                if (this.multiplier >= this.crashPoint) {
                    this.state = 'CRASHED';
                    if (this.playerBet) showMessage(`크래시! 베팅 금액을 잃었습니다.`);
                }
            } else if (this.state === 'CRASHED') {
                this.statusDisplay.textContent = `CRASHED @ ${this.crashPoint.toFixed(2)}x`;
                this.multiplierDisplay.textContent = `${this.crashPoint.toFixed(2)}x`;
                this.multiplierDisplay.classList.add('text-red-500');
                this.betBtn.disabled = true; this.betBtn.textContent = 'Crashed';
                this.stop();
                setTimeout(() => this.start(), 5000);
            }
        },

        draw() {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            if (this.state === 'RUNNING' || this.state === 'CRASHED') {
                const displayMultiplier = this.state === 'CRASHED' ? this.crashPoint : this.multiplier;
                this.multiplierDisplay.textContent = `${parseFloat(displayMultiplier).toFixed(2)}x`;
                
                const visualMaxTime = (Math.log(this.VISUAL_MAX_MULTIPLIER) / 0.17);
                
                this.ctx.beginPath(); this.ctx.moveTo(0, this.canvas.height);
                this.ctx.strokeStyle = '#f97316'; this.ctx.lineWidth = 4;
                const gradient = this.ctx.createLinearGradient(0, this.canvas.height, 0, 0);
                gradient.addColorStop(0, 'rgba(249, 115, 22, 0)');
                gradient.addColorStop(1, 'rgba(249, 115, 22, 0.4)');
                this.ctx.fillStyle = gradient;

                for(let t=0; t <= visualMaxTime; t+=0.05) {
                    const x = (t / visualMaxTime) * this.canvas.width;
                    if (x > this.canvas.width) break;

                    const y_mult = Math.exp(t * 0.17);
                    const y_max_mult = this.VISUAL_MAX_MULTIPLIER;
                    const y = this.canvas.height - ((y_mult - 1) / (y_max_mult - 1)) * this.canvas.height;
                    
                    if (y_mult > displayMultiplier) break;
                    this.ctx.lineTo(x, y);
                }
                const currentElapsedTime = (Date.now() - this.startTime) / 1000;
                const currentX = (currentElapsedTime / visualMaxTime) * this.canvas.width;
                this.ctx.lineTo(Math.min(currentX, this.canvas.width), this.canvas.height);
                this.ctx.closePath();
                
                this.ctx.stroke();
                this.ctx.fill();
            }
        },
        
        updateBetButtonState() {
            if (this.state === 'WAITING') {
                this.betBtn.disabled = balance < betAmount || betAmount <= 0;
            }
        },

        handleBet() {
            if(this.state === 'WAITING') {
                if(betAmount > 0 && balance >= betAmount) {
                    balance -= betAmount; updateAllBalances();
                    this.playerBet = { amount: betAmount };
                    this.betBtn.textContent = '베팅 완료'; this.betBtn.disabled = true;
                    showMessage(`₩${betAmount.toLocaleString()} 베팅 완료!`, 'success');
                } else { showMessage('잔액이 부족하거나 베팅 금액이 올바르지 않습니다.'); }
            } else if (this.state === 'RUNNING' && this.playerBet) {
                const winnings = this.playerBet.amount * this.multiplier;
                balance += winnings; updateAllBalances();
                showMessage(`₩${winnings.toLocaleString()} 획득! (${this.multiplier.toFixed(2)}x)`, 'success');
                this.playerBet = null;
                this.betBtn.textContent = '획득 완료'; this.betBtn.disabled = true;
            }
        }
    };

    // --- Main Event Listeners ---
    function setupGlobalEventListeners() {
        document.getElementById('plinkoLobbyBtn').addEventListener('click', () => gameManager.switchTo(plinkoGame));
        document.getElementById('crashLobbyBtn').addEventListener('click', () => gameManager.switchTo(crashGame));

        document.querySelectorAll('.menuBtn').forEach(btn => btn.addEventListener('click', () => {
            if (activeGame && activeGame.stop && activeGame.view.id !== 'crashGameView') {
                activeGame.stop();
            }
            activeGame = null;
            plinkoGame.view.classList.add('hidden');
            crashGame.view.classList.add('hidden');
            lobbyView.classList.remove('hidden');
        }));
        
        document.querySelectorAll('.chargeBtn').forEach(btn => btn.addEventListener('click', () => chargeModal.classList.remove('hidden')));
        closeModalBtn.addEventListener('click', () => chargeModal.classList.add('hidden'));
        chargeModal.addEventListener('click', (e) => { if (e.target === chargeModal) chargeModal.classList.add('hidden'); });
        
        document.querySelectorAll('.charge-amount-btn').forEach(btn => btn.addEventListener('click', () => {
            const amount = parseInt(btn.dataset.amount, 10);
            balance += amount; updateAllBalances();
            showMessage(`₩${amount.toLocaleString()}이 충전되었습니다.`, 'success');
        }));

        document.querySelectorAll('.betHalf').forEach(btn => btn.addEventListener('click', () => adjustBet(0.5)));
        document.querySelectorAll('.betDouble').forEach(btn => btn.addEventListener('click', () => adjustBet(2)));
        
        document.querySelectorAll('.betAmount').forEach(input => {
            input.addEventListener('input', (e) => {
                let value = e.target.value.replace(/[^0-9]/g, '');
                betAmount = value ? parseInt(value, 10) : 0;
                updateBetControls();
            });
            input.addEventListener('blur', (e) => {
                if (betAmount > balance) betAmount = balance;
                updateBetControls();
            });
        });
        
        document.querySelectorAll('.bet-slider').forEach(slider => {
            slider.addEventListener('input', (e) => {
                const percentage = parseInt(e.target.value, 10);
                betAmount = (balance * percentage) / 100;
                updateBetControls();
            });
        });
        
        plinkoGame.view.querySelector('.plinkoBetBtn').addEventListener('click', () => plinkoGame.placeBet());
        crashGame.view.querySelector('.crashBetBtn').addEventListener('click', () => crashGame.handleBet());
    }
    
    // --- Start Application ---
    updateAllBalances();
    updateBetControls();
    setupGlobalEventListeners();

    </script>
</body>
</html>
